# QQE-2152 - Allow to assign a user and roles to a scheduled task

JIRA: https://issues.redhat.com/browse/QQE-2152

Upstream PRs:
- https://github.com/quarkusio/quarkus-security/pull/82
- https://github.com/quarkusio/quarkus/pull/51679

The upstream PRs introduce a new `@RunAsUser` annotation that can be applied to methods annotated with `@Scheduled`.  
The annotation allows configuring a `SecurityIdentity` that is active only for the duration of the scheduled task execution, 
enabling scheduled jobs to interact with security-protected application code.

## Scope of the testing
Testing will focus on runtime integration behavior of scheduled tasks executed with and without an assigned user identity.

### Default scheduled execution (no assigned identity)
- Verify that:
  - security-protected application logic is not accessible

### Scheduled execution with assigned identity
- Verify that:
  - the task is treated as authenticated
  - authentication-based security constraints are satisfied

### Role-based authorization for scheduled tasks
- Verify that:
  - access is granted when the required role is assigned
  - access is granted when multiple roles are assigned and one matches
  - access is denied when required roles are missing

### Authorization without identity
- Verify that:
  - execution is rejected due to missing authentication
  - scheduled execution follows the same security semantics as regular application execution

### Unrestricted access
- Verify that:
  - tasks without an assigned identity can invoke `@PermitAll` methods successfully

### Identity lifecycle and isolation
- Verify that:
  - assigned identities are scoped to a single task execution
  - identities do not propagate between scheduled task executions

### Failure isolation between scheduled tasks
- Verify that:
  - failures in one scheduled secure task do not prevent execution of other scheduled tasks

## Impact on test suites and testing automation
The `scheduling/quartz` module in the Test Suite will be extended with new tests covering the scenarios listed above.

## Impact on resources
The expected execution time will increase by 1-1,5 minutes in JVM mode.
Other test modes:  Native and OpenShift are not affected.

## Getting familiar with the feature
- Review the `@RunAsUser` annotation
- Understand how `@RunAsUser` integrates with the scheduler execution lifecycle
- Review documentation section:
  - https://quarkus.io/version/main/guides/scheduler-reference#assign-a-user-and-roles-to-a-scheduled-task
- Review upstream unit test coverage to understand:
  - interaction with security annotations (`@Authenticated`, `@RolesAllowed`)
  - expected identity scoping semantics
  - validation rules and supported usage

## Contacts
* Tester: Georgii Troitskii <gtroitsk@ibm.com>

## References
- https://quarkus.io/version/main/guides/scheduler-reference#assign-a-user-and-roles-to-a-scheduled-task
